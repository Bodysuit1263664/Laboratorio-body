#!/usr/bin/bash
#Created on Dec/2018 and upgraded on Ago/2021 by @Ivam3
IFS=$'\n\t'
trap ctrl_c 2
source $PREFIX/share/i-Haklab/.set/var/variables
source $iHAKLAB/.set/functions/functions
ctrl_c(){ printf "$Y\n\n\t\t   [¿] Need a help [?]$B\n\t\tTelegram : t.me/Ivam3_Bot$W\n\n";exit;}
chk-iHaklab
chk-Cuser
[ $# -eq 0 ] && { printf >&2 "$R(_>)─➤$W missing argument, type $(basename $0) -h for help";exit;}
clear;banner
case "$1" in
	-h|help)
		Menu
		;;
	-v|version)
		printf "$G(_>)─➤$W i-Haklab $(grep -om 1 "v.*.*" $iHAKLAB/README.md|awk '{print $1}') 2021 by Ivam3 - It is a hacking laboratory that contains open source tools recommended by Ivam3."
		;;
	about)
		[[ -e $iHAKLAB/.set/libexec/Tools/Readme/$2 ]] && cat $iHAKLAB/.set/libexec/Tools/Readme/$2 || STDERR
		;;
	install|remove)
		if [[ $2 ]];then
			for i in ${@:2};do
				bash $iHAKLAB/.set/share/$1 $i
			done
			if [[ $(ruby -v |cut -c 6-10) != "2.7.2" ]];then
				printf "$Y(_>)─➤$W Downgrading ruby at version 2.7.2.."
#		bash <(curl -fsSL "http://git.io/abhacker-repo") --install ruby=2.7.2
				if [ ! -e $PREFIX/etc/apt/sources.list.d/abhacker.repo.list ];then
					printf "$Y(_>)─➤$W Installing Abhacker repositories.$G"
					wget -q "${iHDB}/fix-tools/instAbhackerRepo" -O $TMPDIR/abh.tmp
					chmod +x $TMPDIR/abh.tmp
					exec $TMPDIR/abh.tmp --install ruby=2.7.2 >/dev/null 2>/dev/null
					rm $TMPDIR/abh.tmp
					printf "$G(_>)─➤$W DONE!!\n"
				else
					exec yes|apt install ruby=2.7.2 >/dev/null 2>/dev/null
				fi
				gem install --quiet --silent bundler:2.2.11
				rm -rf $PREFIX/lib/ruby/gems/2.7.0/specifications/default/bundler-2.1.4.gemspec
				printf "$G.DONE!!$W\n"
			fi
		else
			STDERR
		fi
		;;
	restore)
		printf "$Y(_>)─➤$W Restoring (It could take a while)..";
		rm -rf $iHAKLAB
		git clone --quiet https://github.com/Ivam3/i-Haklab.git $iHAKLAB
		if [[ -d $iHAKLAB ]];then
			printf "$G. DONE!!$W\n"
		else
			printf "$R\n(_>)─➤ ERR_restore";ctrl_c
		fi
		;;
	reinstall)
		[[ -e $iHAKLAB/.set/share/reinstall ]] || { printf >&2 "$R\n(_>)─➤ Fatal error\n$Y(_>)─➤ please run$G i-Haklab restore$Y and try again$W\n";exit;}
		bash $iHAKLAB/.set/share/reinstall
		;;
	root)
		command -v proot >/dev/null || yes|apt install proot;clear
		exec proot -0 -w ~ $SHELL
		;;
	show)
		[[ $2 ]] && bash $iHAKLAB/.set/share/$1 ${@:2} || STDERR
		;;
	speedtest)
		command -v python >/dev/null || yes|apt install python >/dev/null 2>&1
		command -v speedtest-cli >/dev/null || python -m pip install --no-color --quiet --no-cache-dir speedtest-cli
		printf "$Y(_>)─➤$W Running speed test.\n"
		speedtest-cli
		;;
	update)
		TMP_FILE1=$(mktemp)
		wget -q $iHDB/share/upgrade -O $TMP_FILE1
		RMONTH=$(grep "Modify" $TMP_FILE1 | cut -d "-" -f2)
		RDAY=$(grep "Modify" $TMP_FILE1 | cut -d "-" -f3)
		LMONTH=$(stat $iHAKLAB | grep Modify | awk '{print $2}' | cut -d "-" -f2)
		LDAY=$(stat $iHAKLAB | grep Modify | awk '{print $2}' | cut -d "-" -f3)
		Done(){ printf "$G\n\t\t(_>)─>$W Already up to date$G <-(<_)$W\n";}
		if [ $LMONTH -eq $RMONTH ];then
			if [ $LDAY -gt $RDAY ];then
				Done
			else
				printf "$G(_>)─➤$W Upgrading i-Haklab...\n"
				bash $TMP_FILE1
				Done
			fi
		elif [ $LMONTH -gt $RMONTH ]; then
			Done
		else
			printf "$Y(_>)─➤$W Upgrading i-Haklab...\n"
			bash $TMP_FILE1
			Done
		fi
		rm $TMP_FILE1
		;;
	Xwayland)
		for i in x11-repo xwayland;do
			[[ $(pkg list-all|grep -oE "$i") ]] || yes|pkg install $i
		done
		cd ~/
		export XDG_RUNTIME_DIR=${TMPDIR}
		Xwayland :1 >/dev/null &
		env DISPLAY=:1 xfce4-session
		;;
	weechat)
		[[ -e $PREFIX/bin/weechat ]] || yes|apt install weechat
		printf "$Y\n   (_>)─>$W After start weechat type the next commands$Y <─(<_)$Y\n/server add freenode chat.freenode.net/6697 -ssl -autoconnect\n    /set irc.server.freenode.autojoin #Ivam3byCinderella\n                   /connect freenode\n                  /nick your-nickname\n               /join #Ivam3byCinderella$G\n               $R(w)-> USE SOME VPN <-(w)$G\n\n                 Press enter to start$W\n"
		read enter;weechat;k-boom
		;;
	#:::AUTOMATED COMMAND:::#
	bf|esmsg|forwarding|msf|share)
		bash $iHAKLAB/.set/share/$1 ${@:2}
		;;
	*)
		STDERR
		;;
esac
